---
title: "AnnoProbe : An R package for probe annotating"
author: "Yujia Xiang & Jianming Zeng"
date: "`r Sys.Date()`"
output: 
  prettydoc::html_pretty:
    toc: true
    theme: cayman # cayman, hpstr, leonids, tactile
    highlight: github
  pdf_document:
    toc: true
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r echo=FALSE, results='hide', message=FALSE}
library(GEOquery)
#library(AnnoProbe)
```


## 1. Introduction
AnnoProbe is a database contains 146 probe annotations which integrated of Soft Annotations from GEO , Bioconductor Annotations from Bioconductor as well as Customed probe annotations annotated by our pipeline. AnnoProbe allows users to quickly and easily access the latest probe annotations and improve their data analysis qualities.

In addition, AnnoProbe web-interface (http://192.144.162.230:3838/AnnoProbe/)  provides a self-annotating workflow that helps users quickly get customed probe annotations.

```{r}
library(AnnoProbe)
```

## 2. Accessing probe annotation data from AnnoProbe database
Before get annotation data from AnnoProbe, please use function `checkGPL` or `getGPLlist` to check your GEO Platform is in our annotation list. Otherwise, you can use our `AnnoProbe Web-Interface` (Introduce as followings ) to custom re-annotate your probe sets or `getGPLsoft` function to download annotations from GEO.

```{r}
checkGPL("GPL13607")
#gpl13607 <- getGPLsoft("GPL13607", destdir="./inst/extdata/")
```

We perform function `getAnno` to help users access probe annotations.
`getAnno` has four parameters: _gplnum_ , _source_ , _biotype_ and _lncRNA_ 

+ `gplnum` : The GEO Platform Accession Number
+ `source` : Where the annotation data comes from. (`pipe` refs to our customed annotations, `soft` soft annotations download from GEO and companies' websites, `bioc` bioconductor annotations integrated from bioconductor packages ) 
+ `biotype` : Gene biotypes in GENCODE(eg. protein-coding, non_coding ...)
+ `lncRNA` : The default is FALSE. (if select `True` , users can access the lncRNA arrays annotaion data produced by our customed pipeline)

```{r}
gplnum <- "GPL10332"
humanAnno <- getAnno(gplnum,source="pipe")
head(humanAnno)
```

## 3. Matching probeids with gene symbols
Function `probeIdmap` matching probeids with gene symbols

+ `gplnum` The GEO Platform Accession Number
+ `datasets` The probe annotations, which contains the corresponding relationship of gene symbols and probe ids
+ `probeIdcol` The column name of probe ids in annotation datasets

Notes: This function will lose some probe ids that are not in the gene annotations
```{r}
probeids <- c("A_23_P101521","A_33_P3695548","A_33_P3266889")
gplnum <- "GPL10332"
datasets <- getAnno(gplnum,source="pipe")
head(datasets)
mapRes <- probeIdmap(probeids, datasets, probeIdcol = "probe_id")
mapRes <- na.omit(mapRes) ## filter NA ids
head(mapRes)
```

## 4. Using AnnoProbe Web-Interface to re-annotate probe sequences
AnnoProbe Workflow is a shinyApp to re-annotate probe sequences (Avaliable at: http://192.144.162.230:3838/AnnoProbe/ ).

In Home page, users can download probe annotations directly by **`search`** and **`download`** buttons .
![](figures/home.png)

In Pipeline page, users are able to custome re-annotate their microarray probe sequences .

![](figures/pipeline.png)

For more details, please visit the website.

## 5. Other Functions

#### 5.1 Filter expression matrix
Function `filterEM` 

```{r}
eMatrix <- system.file("extdata", "matrixData.Rdata", package="AnnoProbe")
allMapIds <- system.file("extdata", "probe2gene.Rdata", package="AnnoProbe")
load(eMatrix)
load(allMapIds)
## head(matrixData)
## head(probe2gene)
res <- filterEM(matrixData,probe2gene,omitNA=T)
head(res)
```

#### 5.2 Converting gene symbols to other Ids




## 6. Case Study : Data Mining with microarray data deposited in GEO

There are many valuable microarray data sets deposited in GEO database. We can download those data and perform bioinformatics analysis to reveal new biological insights . Following is a case study for users using `AnnoProbe` package to remine GEO data sets.

+ Download microarray data from GEO
```{r}
library(AnnoProbe)
library(GEOquery)
## download GSE27533 data
gse27533 <- getGEO('GSE27533', destdir=".", AnnotGPL = F, getGPL = F)  
## expression matrix
eset <- exprs(gse27533[[1]])
head(eset[,1:4])
## pheno data
phenoDat <- pData(gse27533[[1]])
head(phenoDat[,1:4])
```

+ Differential gene expression analysis
```{r}
library(limma)
groupList=factor(c(rep('control',3),rep('IL-17A',3))) 
design=model.matrix(~factor(groupList))
design
fit=lmFit(eset,design)
fit=eBayes(fit) 
deg=topTable(fit,coef=2,n=Inf)
head(deg) 
```


+ Annotating probe IDs
```{r}
pfilter_DEG <- deg[which((deg$adj.P.Val < 0.05 & deg$logFC > 1) | (deg$adj.P.Val < 0.05 & deg$logFC < -1)),]
# annotating probe IDs using AnnoProbe
probe2symbol=AnnoProbe::getAnno("GPL10558",source="pipe",biotype = "all")
probeIdmapRes=AnnoProbe::probeIdmap(rownames(pfilter_DEG), probe2symbol, probeIdcol = "probe_id")
diff_Genes=unique(probeIdmapRes$pipeAnno)
```

+ Gene ontology enrichment
```{r}
library(clusterProfiler)
library(org.Hs.eg.db)
customedGO <- enrichGO(gene         = diff_Genes,
                         OrgDb         = org.Hs.eg.db,
                         keyType       = 'SYMBOL',
                         ont           = "ALL",
                         pAdjustMethod = "BH",
                         pvalueCutoff  = 0.01,
                         qvalueCutoff  = 0.05)
barplot(customedGO)
```

## 7. Data Updates
AnnoProbe probe annotaion data will be updated per three months. 

## 8. Help
If you have questions/issues, please visit AnnoProbe help homepage first. Your problems are mostly documented. If you think you found a bug, please follow the guide and provide a reproducible example to be posted on github issue tracker. For questions,  please post to Bioconductor support site and tag your post with AnnoProbe or connect Email : XXXX DOT XXX .


